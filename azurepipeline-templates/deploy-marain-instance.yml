parameters:
  azureServiceConnection:
  azureSubscriptionId:
  azureTenantId:
  azureLocation:
  marainEnvironmentSuffix:
  marainInstanceType:
  workingDirectory:
    
steps:
- task: AzureCLI@1
  displayName: 'Prepare azure-cli environment'
  inputs:
    azureSubscription: '$(azureServiceConnection)'
    scriptLocation: inlineScript
    inlineScript: |
      echo "##vso[task.setvariable variable=AZURE_CLIENT_ID;issecret=true]${servicePrincipalId}"
      echo "##vso[task.setvariable variable=AZURE_CLIENT_SECRET;issecret=true]${servicePrincipalKey}"
    addSpnToEnvironment: true
    failOnStandardError: true

- task: AzurePowerShell@5
  displayName: 'Deploy Marain instance'
  inputs:
    azureSubscription: '$(azureServiceConnection)'
    ScriptType: InlineScript
    Inline: |
      $env:AZURE_CLIENT_ID = "$(AZURE_CLIENT_ID)"
      $env:AZURE_CLIENT_SECRET = "$(AZURE_CLIENT_SECRET)"
      ./Deploy-MarainInstanceInfrastructure.ps1 `
            -AzureLocation $(azureLocation) `
            -EnvironmentSuffix $(marainEnvironmentSuffix) `
            -AadTenantId $(azureTenantId) `
            -SubscriptionId $(azureSubscriptionId) `
            -InstanceManifest ../InstanceManifests/$(marainInstanceType).json
    preferredAzurePowerShellVersion: '2.6.0'
    pwsh: true
    workingDirectory: $(workingDirectory)