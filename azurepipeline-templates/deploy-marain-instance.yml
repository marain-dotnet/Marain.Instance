parameters:
  azureServiceConnection:
  azureSubscriptionId:
  azureTenantId:
  azureLocation:
  marainEnvironmentSuffix:
  marainManifestPath: "../InstanceManifests"
  marainInstanceType:
  marainResourcePrefix:
  workingDirectory:
    
steps:
- task: AzureCLI@1
  displayName: 'Prepare azure-cli environment'
  inputs:
    azureSubscription: '${{ parameters.azureServiceConnection }}'
    scriptLocation: inlineScript
    inlineScript: |
      echo "##vso[task.setvariable variable=AZURE_CLIENT_ID;issecret=true]${servicePrincipalId}"
      echo "##vso[task.setvariable variable=AZURE_CLIENT_SECRET;issecret=true]${servicePrincipalKey}"
    addSpnToEnvironment: true
    failOnStandardError: true

- task: AzurePowerShell@4
  displayName: 'Deploy Marain instance'
  inputs:
    azureSubscription: '${{ parameters.azureServiceConnection }}'
    ScriptType: InlineScript
    Inline: |
      $env:AZURE_CLIENT_ID = "$(AZURE_CLIENT_ID)"
      $env:AZURE_CLIENT_SECRET = "$(AZURE_CLIENT_SECRET)"
      $ProgressPreference = "SilentlyContinue"
      ./Deploy-MarainInstanceInfrastructure.ps1 `
            -AzureLocation ${{ parameters.azureLocation }} `
            -EnvironmentSuffix ${{ parameters.marainEnvironmentSuffix }} `
            -AadTenantId ${{ parameters.azureTenantId }} `
            -SubscriptionId ${{ parameters.azureSubscriptionId }} `
            -InstanceManifest ${{ parameters.marainManifestPath }}/${{ parameters.marainInstanceType }}.json `
            -Prefix ${{ parameters.marainResourcePrefix }}
    # Temporarily force a downgrade of the AzurePowerShell cmdlets because (as of September 2020 and v4.6.0) a bug
    # was introduced which breaks use of securestring with ARM templates:
    # https://github.com/Azure/azure-powershell/issues/12792
    # https://github.com/Azure/azure-powershell/issues/12819
    # Once this issue is fixed, we should revert back to using the latest version of the cmdlets.
    preferredAzurePowerShellVersion: '4.4.0'
    pwsh: true
    workingDirectory: ${{ parameters.workingDirectory }}